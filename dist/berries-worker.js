/*
 Berries, a Javascript library for rendering geodata in 3d, using three.js
 Still very much a work in progress
 Created by Derek Kniffin
*/
function getHeight(t,e){var n=e.levels*e.levelHeight;if(t)if(t.height)n=t.height;else{var a=e.levels;if(t["building:levels"])a=t["building:levels"];else if(t.building)switch(t.building){case"house":case"garage":case"roof":case"hut":a=1;break;case"school":a=2;break;case"apartments":case"office":a=3;break;case"hospital":a=4;break;case"hotel":a=10}var r=e.levelHeight;n=a*r}return n}function roadWidth(t,e){var n=e.lanes*e.laneWidth;if(t)if(t.width)n=t.width;else{var a=e.lanes;if(t.lanes)a=t.lanes;else if(t.highway)switch(t.highway){case"motorway":case"trunk":case"primary":case"secondary":a=4;break;case"tertiary":case"residential":a=2;break;case"service":case"track":a=1}var r=e.laneWidth;n=a*r}return n}B={},B.Worker={w:"undefined"==typeof window?self:new Worker("lib/js/berries/dist/berries-worker-src.js"),onMsgHandlers:{},addMsgHandler:function(t,e){B.Worker.onMsgHandlers[t]=e},sendMsg:function(t,e,n){e&&this.addMsgHandler(t.action,e),B.Worker.w.postMessage(t,n)}},B.Worker.w.onmessage=function(t){if("undefined"==typeof B.Worker.onMsgHandlers[t.data.action])throw new Error("Unknown action type recieved: "+t.data.action);B.Worker.onMsgHandlers[t.data.action](t)},B.Worker.addMsgHandler("loadLibrary",function(t){B.Logger.log("debug","Loading "+t.data.url),importScripts(t.data.url)}),B.Logger={log:function(t,e){B.Worker.sendMsg({action:"log",type:t,message:e})}},B.WebWorkerGeometryHelper={deconstruct:function(t){for(var e=new Float32Array(3*t.vertices.length),n=0,a=t.vertices.length;a>n;n++){var r=t.vertices[n];e[3*n]=r.x,e[3*n+1]=r.y,e[3*n+2]=r.z}for(var o=new Float32Array(3*t.faces.length),s=new Float32Array(t.faces.length),i=0,l=t.faces.length;l>i;i++){var u=t.faces[i];o[3*i]=u.a,o[3*i+1]=u.b,o[3*i+2]=u.c,s[i]=u.materialIndex}return{faces:o,verts:e,mats:s}},reconstruct:function(t,e){for(var n=t.vertices,a=0,r=n.length;r>a;a+=3)e.vertices[a/3]=new THREE.Vector3(n[a],n[a+1],n[a+2]);for(var o=t.faces,s=t.materials,i=0,l=o.length;l>i;i+=3)e.faces[i/3]=new THREE.Face3(o[i],o[i+1],o[i+2]),"undefined"!=typeof s&&(e.faces[i/3].materialIndex=s[i/3]);e.computeFaceNormals()}},B.Class=function(){},B.Class.extend=function(t){var e=function(){this.initialize&&this.initialize.apply(this,arguments),this._initHooks&&this.callInitHooks()},n=function(){};n.prototype=this.prototype;var a=new n;a.constructor=e,e.prototype=a;for(var r in this)this.hasOwnProperty(r)&&"prototype"!==r&&(e[r]=this[r]);t.statics&&(B.extend(e,t.statics),delete t.statics),t.includes&&(B.Util.extend.apply(null,[a].concat(t.includes)),delete t.includes),t.options&&a.options&&(t.options=B.extend({},a.options,t.options)),B.extend(a,t),a._initHooks=[];var o=this;return e.__super__=o.prototype,a.callInitHooks=function(){if(!this._initHooksCalled){o.prototype.callInitHooks&&o.prototype.callInitHooks.call(this),this._initHooksCalled=!0;for(var t=0,e=a._initHooks.length;e>t;t++)a._initHooks[t].call(this)}},e},B.Class.include=function(t){B.extend(this.prototype,t)},B.Class.mergeOptions=function(t){B.extend(this.prototype.options,t)},B.Class.addInitHook=function(t){var e=Array.prototype.slice.call(arguments,1),n="function"==typeof t?t:function(){this[t].apply(this,e)};this.prototype._initHooks=this.prototype._initHooks||[],this.prototype._initHooks.push(n)},B.Util={extend:function(t){var e,n,a,r,o=Array.prototype.slice.call(arguments,1);for(n=0,a=o.length;a>n;n++){r=o[n]||{};for(e in r)r.hasOwnProperty(e)&&(t[e]=r[e])}return t},bind:function(t,e){var n=arguments.length>2?Array.prototype.slice.call(arguments,2):null;return function(){return t.apply(e,n||arguments)}},stamp:function(){var t=0,e="_berries_id";return function(n){return n[e]=n[e]||++t,n[e]}}(),invokeEach:function(t,e,n){var a,r;if("object"==typeof t){r=Array.prototype.slice.call(arguments,3);for(a in t)e.apply(n,[a,t[a]].concat(r));return!0}return!1},limitExecByInterval:function(t,e,n){var a,r;return function o(){var s=arguments;return a?(r=!0,void 0):(a=!0,setTimeout(function(){a=!1,r&&(o.apply(n,s),r=!1)},e),t.apply(n,s),void 0)}},falseFn:function(){return!1},formatNum:function(t,e){var n=Math.pow(10,e||5);return Math.round(t*n)/n},trim:function(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")},splitWords:function(t){return B.Util.trim(t).split(/\s+/)},setOptions:function(t,e){return t.options=B.extend({},t.options,e),t.options},getParamString:function(t,e,n){var a=[];for(var r in t)a.push(encodeURIComponent(n?r.toUpperCase():r)+"="+encodeURIComponent(t[r]));return(e&&-1!==e.indexOf("?")?"&":"?")+a.join("&")},compileTemplate:function(t,e){return t=t.replace(/\{ *([\w_]+) *\}/g,function(t,n){return'" + o["'+n+'"]'+("function"==typeof e[n]?"(o)":"")+' + "'}),new Function("o",'return "'+t+'";')},template:function(t,e){var n=B.Util._templateCache=B.Util._templateCache||{};return n[t]=n[t]||B.Util.compileTemplate(t,e),n[t](e)},arrayMerge:function(t,e){for(var n=+e.length,a=0,r=t.length;n>a;a++)t[r++]=e[a];return t.length=r,t},isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)},getBerriesPath:function(){var t,e,n,a,r,o=document.getElementsByTagName("script"),s=/[\/^]berries[\-\._]?([\w\-\._]*)\.js\??/;for(t=0,e=o.length;e>t;t++)if(n=o[t].src,a=n.match(s))return r=n.split(s)[0],r?r+"/":""},getTexturePath:function(){return this.getBerriesPath()+"textures"},getObjPath:function(){return this.getBerriesPath()+"obj"},getDaePath:function(){return this.getBerriesPath()+"dae"},emptyImageUrl:"data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="},"undefined"!=typeof window&&!function(){function t(t){var e,n,a=["webkit","moz","o","ms"];for(e=0;e<a.length&&!n;e++)n=window[a[e]+t];return n}function e(t){var e=+new Date,a=Math.max(0,16-(e-n));return n=e+a,window.setTimeout(t,a)}var n=0,a=window.requestAnimationFrame||t("RequestAnimationFrame")||e,r=window.cancelAnimationFrame||t("CancelAnimationFrame")||t("CancelRequestAnimationFrame")||function(t){window.clearTimeout(t)};B.Util.requestAnimFrame=function(t,n,r,o){return t=B.bind(t,n),r&&a===e?(t(),void 0):a.call(window,t,o)},B.Util.cancelAnimFrame=function(t){t&&r.call(window,t)}}(),B.extend=B.Util.extend,B.bind=B.Util.bind,B.stamp=B.Util.stamp,B.setOptions=B.Util.setOptions,B.LatLng=function(t,e){var n=parseFloat(t),a=parseFloat(e);if(isNaN(n)||isNaN(a))throw new Error("Invalid LatLng object: ("+t+", "+e+")");this.lat=n,this.lng=a},B.extend(B.LatLng,{DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,MAX_MARGIN:1e-9}),B.LatLng.prototype={equals:function(t){if(!t)return!1;t=B.latLng(t);var e=Math.max(Math.abs(this.lat-t.lat),Math.abs(this.lng-t.lng));return e<=B.LatLng.MAX_MARGIN},toString:function(t){return"LatLng("+B.Util.formatNum(this.lat,t)+", "+B.Util.formatNum(this.lng,t)+")"},distanceTo:function(t){t=B.latLng(t);var e=6378137,n=B.LatLng.DEG_TO_RAD,a=(t.lat-this.lat)*n,r=(t.lng-this.lng)*n,o=this.lat*n,s=t.lat*n,i=Math.sin(a/2),l=Math.sin(r/2),u=i*i+l*l*Math.cos(o)*Math.cos(s);return 2*e*Math.atan2(Math.sqrt(u),Math.sqrt(1-u))},wrap:function(t,e){var n=this.lng;return t=t||-180,e=e||180,n=(n+e)%(e-t)+(t>n||n===e?e:t),new B.LatLng(this.lat,n)}},B.latLng=function(t,e){return t instanceof B.LatLng?t:B.Util.isArray(t)?new B.LatLng(t[0],t[1]):void 0===t||null===t?t:"object"==typeof t&&"lat"in t?new B.LatLng(t.lat,"lng"in t?t.lng:t.lon):new B.LatLng(t,e)},B.LatLngBounds=function(t,e){if(t)for(var n=e?[t,e]:t,a=0,r=n.length;r>a;a++)this.extend(n[a])},B.LatLngBounds.prototype={extend:function(t){return t?(t="number"==typeof t[0]||"string"==typeof t[0]||t instanceof B.LatLng?B.latLng(t):B.latLngBounds(t),t instanceof B.LatLng?this._southWest||this._northEast?(this._southWest.lat=Math.min(t.lat,this._southWest.lat),this._southWest.lng=Math.min(t.lng,this._southWest.lng),this._northEast.lat=Math.max(t.lat,this._northEast.lat),this._northEast.lng=Math.max(t.lng,this._northEast.lng)):(this._southWest=new B.LatLng(t.lat,t.lng),this._northEast=new B.LatLng(t.lat,t.lng)):t instanceof B.LatLngBounds&&(this.extend(t._southWest),this.extend(t._northEast)),this):this},pad:function(t){var e=this._southWest,n=this._northEast,a=Math.abs(e.lat-n.lat)*t,r=Math.abs(e.lng-n.lng)*t;return new B.LatLngBounds(new B.LatLng(e.lat-a,e.lng-r),new B.LatLng(n.lat+a,n.lng+r))},getCenter:function(){return new B.LatLng((this._southWest.lat+this._northEast.lat)/2,(this._southWest.lng+this._northEast.lng)/2)},getSouthWest:function(){return this._southWest},getNorthEast:function(){return this._northEast},getNorthWest:function(){return new B.LatLng(this.getNorth(),this.getWest())},getSouthEast:function(){return new B.LatLng(this.getSouth(),this.getEast())},getWest:function(){return this._southWest.lng},getSouth:function(){return this._southWest.lat},getEast:function(){return this._northEast.lng},getNorth:function(){return this._northEast.lat},contains:function(t){t="number"==typeof t[0]||t instanceof B.LatLng?B.latLng(t):B.latLngBounds(t);var e,n,a=this._southWest,r=this._northEast;return t instanceof B.LatLngBounds?(e=t.getSouthWest(),n=t.getNorthEast()):e=n=t,e.lat>=a.lat&&n.lat<=r.lat&&e.lng>=a.lng&&n.lng<=r.lng},intersects:function(t){t=B.latLngBounds(t);var e=this._southWest,n=this._northEast,a=t.getSouthWest(),r=t.getNorthEast(),o=r.lat>=e.lat&&a.lat<=n.lat,s=r.lng>=e.lng&&a.lng<=n.lng;return o&&s},toBBoxString:function(){return[this.getWest(),this.getSouth(),this.getEast(),this.getNorth()].join(",")},equals:function(t){return t?(t=B.latLngBounds(t),this._southWest.equals(t.getSouthWest())&&this._northEast.equals(t.getNorthEast())):!1},isValid:function(){return!(!this._southWest||!this._northEast)}},B.latLngBounds=function(t,e){return!t||t instanceof B.LatLngBounds?t:new B.LatLngBounds(t,e)},B.Worker.addMsgHandler("generateTerrain",function(t){var e=t.data.options,n=new XMLHttpRequest;n.responseType="arraybuffer",n.open("GET",t.data.srtmDataSource,!0),n.onload=function(){if(n.response){var t=new Uint16Array(n.response);B.Logger.log("info","Getting SRTM data");var a=B.latLngBounds([[e.bounds[0].lat,e.bounds[0].lng],[e.bounds[1].lat,e.bounds[1].lng]]),r=e.numVertsX,o=e.numVertsY,s=a.getSouthWest(),i=s.distanceTo(a.getSouthEast()),l=s.distanceTo(a.getNorthWest());B.Logger.log("log","Creating the terrain geometry");for(var u=new THREE.PlaneGeometry(i,l,r-1,o-1),c=i/(r-1),g=l/(o-1),h=0,f=u.vertices.length;f>h;h++)u.vertices[h].z=4347*(t[h]/65535);var d=B.WebWorkerGeometryHelper.deconstruct(u);u.computeFaceNormals(),u.computeVertexNormals(),B.Logger.log("debug","Returning geometry..."),B.Worker.sendMsg({action:"generateTerrain",geometryParts:{vertices:d.verts,faces:d.faces,width:i,height:l,numVertsX:r,numVertsY:o,gridSpaceX:c,gridSpaceY:g}},null,[d.verts.buffer,d.faces.buffer])}},n.send(null)}),B.Worker.addMsgHandler("generateBuilding",function(t){var e,n,a=t.data.origin,r=B.latLng(a.lat,a.lng),o=t.data.nodes,s=t.data.tags,i=t.data.options,l=new THREE.Geometry,u={x:r.distanceTo([r.lat,o[0].lon]),y:r.distanceTo([o[0].lat,r.lng])},c=[];for(e in o)c[e]=new THREE.Vector2(r.distanceTo([r.lat,o[e].lon])-u.x,r.distanceTo([o[e].lat,r.lng])-u.y);var g=THREE.Shape.Utils.isClockWise(c);g||c.reverse();var h=getHeight(s,i.heightOptions),f=0,d=f+h,p=[];for(n in c){n=Number(n);var m=c[n],v=n!==c.length-1?n+1:0,E=c[v],w=new THREE.Geometry;w.vertices.push(new THREE.Vector3(m.x,m.y,f)),w.vertices.push(new THREE.Vector3(E.x,E.y,f)),w.vertices.push(new THREE.Vector3(E.x,E.y,d)),w.vertices.push(new THREE.Vector3(m.x,m.y,d)),w.faces.push(new THREE.Face3(2,1,0,null,null,0)),w.faces.push(new THREE.Face3(3,2,0,null,null,0)),THREE.GeometryUtils.merge(l,w),p.push(new THREE.Vector2(m.x,m.y))}var y=new THREE.Geometry,L=new THREE.Shape(p),H=L.extractPoints(),_=THREE.Shape.Utils.triangulateShape(H.shape,H.holes);for(e in H.shape){var T=H.shape[e];y.vertices.push(new THREE.Vector3(T.x,T.y,d))}for(e in _)y.faces.push(new THREE.Face3(_[e][0],_[e][1],_[e][2],null,null,1));y.computeFaceNormals(),THREE.GeometryUtils.merge(l,y),l.computeFaceNormals();var b=B.WebWorkerGeometryHelper.deconstruct(l);B.Worker.sendMsg({action:"generateBuilding",tags:s,geometryParts:{vertices:b.verts,faces:b.faces,materials:b.mats,position:u}},null,[b.verts.buffer,b.faces.buffer,b.mats.buffer])}),B.Worker.addMsgHandler("generateRoad",function(t){var e=t.data.origin,n=B.latLng(e.lat,e.lng),a=t.data.nodes,r=t.data.tags,o=t.data.options,s={x:n.distanceTo([n.lat,a[0].lon]),y:n.distanceTo([a[0].lat,n.lng])},i=roadWidth(r,o),l=o.roadThickness,u=[new THREE.Vector2(-i/2,0),new THREE.Vector2(-i/2,l),new THREE.Vector2(i/2,l),new THREE.Vector2(i/2,0)],c=new THREE.Shape(u),g=[];for(var h in a)g[h]=new THREE.Vector3(n.distanceTo([n.lat,a[h].lon])-s.x,n.distanceTo([a[h].lat,n.lng])-s.y,0);var f;g[0].equals(g[g.length-1])?(g.pop(),f=new THREE.ClosedSplineCurve3(g)):f=new THREE.SplineCurve3(g);var d=g.length,p={tangents:[],normals:[],binormals:[]},m=new THREE.Vector3(1,0,0);for(h=0;d+1>h;h++){var v=h/d,E=f.getTangentAt(v).normalize();p.tangents[h]=E,p.normals[h]=m,p.binormals[h]=E.clone().cross(m)}var w=new THREE.ExtrudeGeometry(c,{extrudePath:f,steps:d,frames:p,closed:!0,extrudeMaterial:0}),y=B.WebWorkerGeometryHelper.deconstruct(w);B.Worker.sendMsg({action:"generateRoad",tags:r,geometryParts:{vertices:y.verts,faces:y.faces,materials:y.mats,position:s}},null,[y.verts.buffer,y.faces.buffer,y.mats.buffer])});