/*
 Berries, a Javascript library for rendering geodata in 3d, using three.js
 Still very much a work in progress
 Created by Derek Kniffin
*/
B={},B.Worker={w:"undefined"==typeof window?self:new Worker("lib/js/berries/dist/berries-worker-src.js"),onMsgHandlers:{},addMsgHandler:function(t,n){B.Worker.onMsgHandlers[t]=n},sendMsg:function(t,n){B.Worker.w.postMessage(t,n)}},B.Worker.w.onmessage=function(t){if("undefined"==typeof B.Worker.onMsgHandlers[t.data.action])throw new Error("Unknown action type recieved: "+t.data.action);B.Worker.onMsgHandlers[t.data.action](t)},B.Worker.addMsgHandler("loadLibrary",function(t){B.Logger.log("debug","Loading "+t.data.url),importScripts(t.data.url)}),B.Logger={log:function(t,n){B.Worker.sendMsg({action:"log",type:t,message:n})}},B.Class=function(){},B.Class.extend=function(t){var n=function(){this.initialize&&this.initialize.apply(this,arguments),this._initHooks&&this.callInitHooks()},e=function(){};e.prototype=this.prototype;var o=new e;o.constructor=n,n.prototype=o;for(var r in this)this.hasOwnProperty(r)&&"prototype"!==r&&(n[r]=this[r]);t.statics&&(B.extend(n,t.statics),delete t.statics),t.includes&&(B.Util.extend.apply(null,[o].concat(t.includes)),delete t.includes),t.options&&o.options&&(t.options=B.extend({},o.options,t.options)),B.extend(o,t),o._initHooks=[];var a=this;return n.__super__=a.prototype,o.callInitHooks=function(){if(!this._initHooksCalled){a.prototype.callInitHooks&&a.prototype.callInitHooks.call(this),this._initHooksCalled=!0;for(var t=0,n=o._initHooks.length;n>t;t++)o._initHooks[t].call(this)}},n},B.Class.include=function(t){B.extend(this.prototype,t)},B.Class.mergeOptions=function(t){B.extend(this.prototype.options,t)},B.Class.addInitHook=function(t){var n=Array.prototype.slice.call(arguments,1),e="function"==typeof t?t:function(){this[t].apply(this,n)};this.prototype._initHooks=this.prototype._initHooks||[],this.prototype._initHooks.push(e)},B.Util={extend:function(t){var n,e,o,r,a=Array.prototype.slice.call(arguments,1);for(e=0,o=a.length;o>e;e++){r=a[e]||{};for(n in r)r.hasOwnProperty(n)&&(t[n]=r[n])}return t},bind:function(t,n){var e=arguments.length>2?Array.prototype.slice.call(arguments,2):null;return function(){return t.apply(n,e||arguments)}},stamp:function(){var t=0,n="_berries_id";return function(e){return e[n]=e[n]||++t,e[n]}}(),invokeEach:function(t,n,e){var o,r;if("object"==typeof t){r=Array.prototype.slice.call(arguments,3);for(o in t)n.apply(e,[o,t[o]].concat(r));return!0}return!1},limitExecByInterval:function(t,n,e){var o,r;return function a(){var i=arguments;return o?(r=!0,void 0):(o=!0,setTimeout(function(){o=!1,r&&(a.apply(e,i),r=!1)},n),t.apply(e,i),void 0)}},falseFn:function(){return!1},formatNum:function(t,n){var e=Math.pow(10,n||5);return Math.round(t*e)/e},trim:function(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")},splitWords:function(t){return B.Util.trim(t).split(/\s+/)},setOptions:function(t,n){return t.options=B.extend({},t.options,n),t.options},getParamString:function(t,n,e){var o=[];for(var r in t)o.push(encodeURIComponent(e?r.toUpperCase():r)+"="+encodeURIComponent(t[r]));return(n&&-1!==n.indexOf("?")?"&":"?")+o.join("&")},compileTemplate:function(t,n){return t=t.replace(/\{ *([\w_]+) *\}/g,function(t,e){return'" + o["'+e+'"]'+("function"==typeof n[e]?"(o)":"")+' + "'}),new Function("o",'return "'+t+'";')},template:function(t,n){var e=B.Util._templateCache=B.Util._templateCache||{};return e[t]=e[t]||B.Util.compileTemplate(t,n),e[t](n)},arrayMerge:function(t,n){for(var e=+n.length,o=0,r=t.length;e>o;o++)t[r++]=n[o];return t.length=r,t},isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)},getBerriesPath:function(){var t,n,e,o,r,a=document.getElementsByTagName("script"),i=/[\/^]berries[\-\._]?([\w\-\._]*)\.js\??/;for(t=0,n=a.length;n>t;t++)if(e=a[t].src,o=e.match(i))return r=e.split(i)[0],r?r+"/":""},getTexturePath:function(){return this.getBerriesPath()+"textures"},getObjPath:function(){return this.getBerriesPath()+"obj"},getDaePath:function(){return this.getBerriesPath()+"dae"},emptyImageUrl:"data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="},"undefined"!=typeof window&&!function(){function t(t){var n,e,o=["webkit","moz","o","ms"];for(n=0;n<o.length&&!e;n++)e=window[o[n]+t];return e}function n(t){var n=+new Date,o=Math.max(0,16-(n-e));return e=n+o,window.setTimeout(t,o)}var e=0,o=window.requestAnimationFrame||t("RequestAnimationFrame")||n,r=window.cancelAnimationFrame||t("CancelAnimationFrame")||t("CancelRequestAnimationFrame")||function(t){window.clearTimeout(t)};B.Util.requestAnimFrame=function(t,e,r,a){return t=B.bind(t,e),r&&o===n?(t(),void 0):o.call(window,t,a)},B.Util.cancelAnimFrame=function(t){t&&r.call(window,t)}}(),B.extend=B.Util.extend,B.bind=B.Util.bind,B.stamp=B.Util.stamp,B.setOptions=B.Util.setOptions,B.LatLng=function(t,n){var e=parseFloat(t),o=parseFloat(n);if(isNaN(e)||isNaN(o))throw new Error("Invalid LatLng object: ("+t+", "+n+")");this.lat=e,this.lng=o},B.extend(B.LatLng,{DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,MAX_MARGIN:1e-9}),B.LatLng.prototype={equals:function(t){if(!t)return!1;t=B.latLng(t);var n=Math.max(Math.abs(this.lat-t.lat),Math.abs(this.lng-t.lng));return n<=B.LatLng.MAX_MARGIN},toString:function(t){return"LatLng("+B.Util.formatNum(this.lat,t)+", "+B.Util.formatNum(this.lng,t)+")"},distanceTo:function(t){t=B.latLng(t);var n=6378137,e=B.LatLng.DEG_TO_RAD,o=(t.lat-this.lat)*e,r=(t.lng-this.lng)*e,a=this.lat*e,i=t.lat*e,s=Math.sin(o/2),u=Math.sin(r/2),l=s*s+u*u*Math.cos(a)*Math.cos(i);return 2*n*Math.atan2(Math.sqrt(l),Math.sqrt(1-l))},wrap:function(t,n){var e=this.lng;return t=t||-180,n=n||180,e=(e+n)%(n-t)+(t>e||e===n?n:t),new B.LatLng(this.lat,e)}},B.latLng=function(t,n){return t instanceof B.LatLng?t:B.Util.isArray(t)?new B.LatLng(t[0],t[1]):void 0===t||null===t?t:"object"==typeof t&&"lat"in t?new B.LatLng(t.lat,"lng"in t?t.lng:t.lon):new B.LatLng(t,n)},B.LatLngBounds=function(t,n){if(t)for(var e=n?[t,n]:t,o=0,r=e.length;r>o;o++)this.extend(e[o])},B.LatLngBounds.prototype={extend:function(t){return t?(t="number"==typeof t[0]||"string"==typeof t[0]||t instanceof B.LatLng?B.latLng(t):B.latLngBounds(t),t instanceof B.LatLng?this._southWest||this._northEast?(this._southWest.lat=Math.min(t.lat,this._southWest.lat),this._southWest.lng=Math.min(t.lng,this._southWest.lng),this._northEast.lat=Math.max(t.lat,this._northEast.lat),this._northEast.lng=Math.max(t.lng,this._northEast.lng)):(this._southWest=new B.LatLng(t.lat,t.lng),this._northEast=new B.LatLng(t.lat,t.lng)):t instanceof B.LatLngBounds&&(this.extend(t._southWest),this.extend(t._northEast)),this):this},pad:function(t){var n=this._southWest,e=this._northEast,o=Math.abs(n.lat-e.lat)*t,r=Math.abs(n.lng-e.lng)*t;return new B.LatLngBounds(new B.LatLng(n.lat-o,n.lng-r),new B.LatLng(e.lat+o,e.lng+r))},getCenter:function(){return new B.LatLng((this._southWest.lat+this._northEast.lat)/2,(this._southWest.lng+this._northEast.lng)/2)},getSouthWest:function(){return this._southWest},getNorthEast:function(){return this._northEast},getNorthWest:function(){return new B.LatLng(this.getNorth(),this.getWest())},getSouthEast:function(){return new B.LatLng(this.getSouth(),this.getEast())},getWest:function(){return this._southWest.lng},getSouth:function(){return this._southWest.lat},getEast:function(){return this._northEast.lng},getNorth:function(){return this._northEast.lat},contains:function(t){t="number"==typeof t[0]||t instanceof B.LatLng?B.latLng(t):B.latLngBounds(t);var n,e,o=this._southWest,r=this._northEast;return t instanceof B.LatLngBounds?(n=t.getSouthWest(),e=t.getNorthEast()):n=e=t,n.lat>=o.lat&&e.lat<=r.lat&&n.lng>=o.lng&&e.lng<=r.lng},intersects:function(t){t=B.latLngBounds(t);var n=this._southWest,e=this._northEast,o=t.getSouthWest(),r=t.getNorthEast(),a=r.lat>=n.lat&&o.lat<=e.lat,i=r.lng>=n.lng&&o.lng<=e.lng;return a&&i},toBBoxString:function(){return[this.getWest(),this.getSouth(),this.getEast(),this.getNorth()].join(",")},equals:function(t){return t?(t=B.latLngBounds(t),this._southWest.equals(t.getSouthWest())&&this._northEast.equals(t.getNorthEast())):!1},isValid:function(){return!(!this._southWest||!this._northEast)}},B.latLngBounds=function(t,n){return!t||t instanceof B.LatLngBounds?t:new B.LatLngBounds(t,n)},B.Worker.addMsgHandler("generateTerrain",function(t){var n=t.data.options;terrain={};var e=new XMLHttpRequest;e.responseType="arraybuffer",e.open("GET",t.data.srtmDataSource,!0),e.onload=function(){if(e.response){var t=new Uint16Array(e.response);B.Logger.log("info","Getting SRTM data");var o=B.latLngBounds([[n.bounds[0].lat,n.bounds[0].lng],[n.bounds[1].lat,n.bounds[1].lng]]),r=n.numVertsX,a=n.numVertsY,i=o.getSouthWest(),s=i.distanceTo(o.getSouthEast()),u=i.distanceTo(o.getNorthWest());B.Logger.log("debug","Creating the terrain geometry");var l=terrain.geometry=new THREE.PlaneGeometry(s,u,r-1,a-1),g=s/(r-1),h=u/(a-1);B.Logger.log("debug","Populating vertices");for(var c=0,p=l.vertices.length;p>c;c++)l.vertices[c].z=4347*(t[c]/65535);B.Logger.log("debug","Done populating vertices"),l.computeFaceNormals(),l.computeVertexNormals(),B.Logger.log("debug","Returning geometry"),B.Worker.sendMsg({action:"generateTerrain",geometryParts:{vertices:l.vertices,faces:l.faces,width:s,height:u,numVertsX:r,numVertsY:a,gridSpaceX:g,gridSpaceY:h}})}},e.send(null)});